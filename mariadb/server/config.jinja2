{#-
Copyright (C) 2013 the Institute for Institutional Innovation by Data
Driven Design Inc.

Permission is hereby granted, free of charge, to any person obtaining
a copy of this software and associated documentation files (the
"Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE  MASSACHUSETTS INSTITUTE OF
TECHNOLOGY AND THE INSTITUTE FOR INSTITUTIONAL INNOVATION BY DATA
DRIVEN DESIGN INC. BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
USE OR OTHER DEALINGS IN THE SOFTWARE.

Except as contained in this notice, the names of the Institute for
Institutional Innovation by Data Driven Design Inc. shall not be used in
advertising or otherwise to promote the sale, use or other dealings
in this Software without prior written authorization from the
Institute for Institutional Innovation by Data Driven Design Inc.

Author: Hung Nguyen Viet <hvnsweeting@gmail.com>
Maintainer: Dang Tung Lam <lamdt@familug.org>
-#}
# {{ pillar['message_do_not_modify'] }}
{#-
MariaDB database server configuration file.

You can copy this file to one of:
- "/etc/mysql/my.cnf" to set global options,
- "~/.my.cnf" to set user-specific options.

One can use all long options that the program supports.
Run program with --help to get a list of available options and with
--print-defaults to see which it would actually understand and use.

For explanations see
http://dev.mysql.com/doc/mysql/en/server-system-variables.html

This will be passed to all mysql clients
It has been reported that passwords should be enclosed with ticks/quotes
especially if they contain "#" chars...
Remember to edit /etc/mysql/debian.cnf when changing the socket location.

* Character sets
Default is Latin1, if you need UTF-8 set all this (in both client and server
sections)
#}

[client]
port = 3306
socket = /var/run/mysqld/mysqld.sock
{%- if salt['pillar.get']('mysql:utf8', False) %}
default-character-set = utf8
{%- endif -%}


{#-
Here is entries for some specific programs
The following values assume you have at least 32M ram

This was formally known as [safe_mysqld]. Both versions are currently parsed.
#}
[mysqld_safe]
socket = /var/run/mysqld/mysqld.sock
nice = 0

[mysqld]
user = mysql
pid-file = /var/run/mysqld/mysqld.pid
socket = /var/run/mysqld/mysqld.sock
port = 3306
bind-address = {{ salt['pillar.get']('mysql:bind', '127.0.0.1') }}
basedir = /usr
datadir = /var/lib/mysql
tmpdir = /tmp
lc_messages_dir = /usr/share/mysql
lc_messages = en_US
skip-external-locking
{%- if salt['pillar.get']('mysql:utf8', False) %}
character-set-server  = utf8
collation-server      = utf8_general_ci
character_set_server   = utf8
collation_server       = utf8_general_ci
{%- endif %}

max_connections = 100
connect_timeout = 5
wait_timeout = 600
bulk_insert_buffer_size = 16M
tmp_table_size = 32M
max_heap_table_size = 32M
{#-
* MyISAM

This replaces the startup script and checks MyISAM tables if needed
the first time they are touched. On error, make copy and try a repair.
#}
myisam_recover          = BACKUP
key_buffer_size = 128M
{#-
open-files-limit = 2000
#}
myisam_sort_buffer_size = 512M
concurrent_insert = 2
read_buffer_size = 2M
read_rnd_buffer_size = 1M
{#-
 * Query Cache Configuration

 Cache only tiny result sets, so we can fit more in the query cache.
#}
query_cache_limit = 128K
query_cache_size = 64M
{#-
 for more write intensive setups, set to DEMAND or OFF
query_cache_type = DEMAND

 * Logging and Replication

 Both location gets rotated by the cronjob.
 Be aware that this log type is a performance killer.
 As of 5.1 you can enable the log at runtime!
general_log_file        = /var/log/mysql/mysql.log
general_log             = 1

 Error logging goes to syslog due to /etc/mysql/conf.d/mysqld_safe_syslog.cnf.

 we do want to know about network errors and such
#}
{%- if salt['pillar.get']('debug', False) %}
log_warnings = 3
slow_query_log = 1
{%- else %}
log_warnings = 2
{%- endif %}
{#-
 Enable the slow query log to see queries with especially long duration
 slow_query_log[={0|1}]
#}
slow_query_log_file = /var/log/mysql/mariadb-slow.log
{#-
log_slow_rate_limit = 1000
log-queries-not-using-indexes
log_slow_admin_statements

 The following can be used as easy to replay backup logs or for replication.
 note: if you are setting up a replication slave, see README.Debian about
       other settings you may need to change.
server-id  = 1
report_host  = master1
auto_increment_increment = 2
auto_increment_offset = 1
log_bin = /var/log/mysql/mariadb-bin
log_bin_index = /var/log/mysql/mariadb-bin.index
expire_logs_days = 10
max_binlog_size         = 100M

 not fab for performance, but safer
sync_binlog  = 1
 slaves
relay_log  = /var/log/mysql/relay-bin
relay_log_index = /var/log/mysql/relay-bin.index
relay_log_info_file = /var/log/mysql/relay-bin.info
log_slave_updates
read_only

 If applications support it, this stricter sql_mode prevents some
 mistakes like inserting invalid dates etc.
sql_mode  = NO_ENGINE_SUBSTITUTION,TRADITIONAL

 * InnoDB

 InnoDB is enabled by default with a 10MB datafile in /var/lib/mysql/.
 Read the manual for more InnoDB related options. There are many!
efault_storage_engine = InnoDB
 you can't just change log file size, requires special procedure
innodb_log_file_size = 50M
#}
innodb_buffer_pool_size = 256M
innodb_file_per_table = 1
innodb_open_files = 400
innodb_io_capacity = 400
innodb_flush_method = O_DIRECT
{#-
* Security Features

Read the manual, too, if you want chroot!
chroot = /var/lib/mysql/

For generating SSL certificates I recommend the OpenSSL GUI "tinyca".

ssl-ca=/etc/mysql/cacert.pem
ssl-cert=/etc/mysql/server-cert.pem
ssl-key=/etc/mysql/server-key.pem
#}

[mysqldump]
quick
quote-names
max_allowed_packet = 16M

[mysql]
{#- no-auto-rehash # faster start of mysql but no tab completion #}

[isamchk]
key_buffer = 16M

{#-
 * IMPORTANT: Additional settings that can override those from this file!
   The files must end with '.cnf', otherwise they'll be ignored.
#}

!includedir /etc/mysql/conf.d/
